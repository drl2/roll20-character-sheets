<div class="tab-spacer">&nbsp;</div>
<input type="radio" name="attr_tab" class="tab notes-tab" value="1" checked /> <span class="tab">Notes</span>
<input type="radio" name="attr_tab" class="tab char-tab" value="2" /> <span class="tab">Character</span>
<input type="radio" name="attr_tab" class="tab veh-tab" value="3" /> <span class="tab">Vehicle</span>

<div class="tab-content notes-tab">
    	<label class="title">Overview (Last update 7/??/2020)</label>
 		<p>This character sheet was conceived as an update to the existing Mighty Protectors character sheet created by Paul M. several years ago.  Goals for its design include:</p>
		<ul>
			<li>Present a look & feel more like the official character sheet.</li>
			<li>Convert limited multi-item lists (such as powers, attacks, etc) into repeating areas so players can configure as many or as few as needed.</li>
			<li>Where possible, automate calculations related to ability scores, etc.</li>
			<li>Simplify roll macros - avoid need for pop-ups, etc.  GMs & players who still want the more complex multi-step rolls can do so through macros; the intention is to set up a wiki page with some specific examples.</li>
		</ul>
		<p><b><i>This is a test version</i></b> and it isn't recommended to use it in any live games!  It's not finished, and its internal functioning is different enough from the old sheet that a signifgicant amount of information won't transfer over.  A migration mechanism is being considered for the future if it's found to be workable.</p>
		<p>Pro Roll20 users who want to test it in a custom game can find the source at this Github address: <input type="text" style="width:550px;" readonly value="https://github.com/drl2/roll20-character-sheets/blob/mighty_protectors/Villains%20and%20Vigilantes/VandVMightyProtectors.html" /></p>
		<br />
		<p><b>To Do:</b></p>
		<ul>
			<li>Implement "To Hit" calculations in Attacks section.  These are complex because of the need to tie together multiple results from the Powers repeating section with the appropriate line in the Attacks section and adjust for which stat the attack is based on.</li>
			<li>Fix the roll macros.  Yeah, still haven't gotten to that.</li>
			<li>Finish the Vehicle tab - right now it's barely more than a placeholder.</li>
			<li>Convert the Movement items into a repeater so players can add/remove as needed</li>
		</ul>
	
		<label class="title">Version 1.9.1 (Released 8/??/2020)</label>
		<ul>
			<li>Added options and modifiers text areas under each power.  This allows for a simple one-line power description on the normally visible list, with the more detailed info down below in the toggle-able area.</li>
			<li></li>
			<li></li>
			<li></li>
		</ul>

		<label class="title">Version 1.9.0 (Released 6/25/2020)</label>
		<ul>
			<li>First public test release.  Do not use for real games!  Much is not implemented yet.</li>
			<li>Most calculations on the character sheet are testable.  "To hit" scores not implemented yet.</li>
			<li>Roll macros unchanged as yet from the original sheet so many won't work currently if they depend on specifically named fields.</li>
			<li>Not much on the vehicle page yet.</li>
		</ul>
</div>


<div class="tab-content char-tab overall-wrapper">
	<div class="main-grid-container">
		<div class="cultural">
			<div class="personal-info-grid-container">
				<div class="info_label personal-info-label">True ID</div>
				<div class="info_field"><input type="text" name="attr_identity_name" title="identity_name"/></div>
				<div class="info_label personal-info-label">Side</div>
				<div class="info_field"><input type="text" name="attr_side" title="side" /></div>
				<div class="info_label personal-info-label">Species</div>
				<div class="info_field"><input type="text" name="attr_species" title="species" /></div>
				<div class="info_label personal-info-label">Birthplace</div>
				<div class="info_field"><input type="text" name="attr_birthplace" title="birthplace" /></div>
				<div class="info_label personal-info-label">Culture</div>
				<div class="info_field"><input type="text" name="attr_culture" title="culture"/></div>
				<div class="info_label personal-info-label">Origin Type</div>
				<div class="info_field"><input type="text" name="attr_origin_type" title="origin_type" /></div>
			</div>
		</div>
		<div class="physical">
			<div class="personal-info-grid-container">
				<div class="info_label personal-info-label short-label">Gender</div>
				<div class="info_field"><input class="med-field" type="text" name="attr_gender" title="gender" /></div>
				<div class="info_label personal-info-label short-label">Age</div>
				<div class="info_field"><input class="short-field" type="text" name="attr_age" title="age" /></div>
				<div class="info_label personal-info-label short-label">Height</div>
				<div class="info_field"><input class="short-field" type="text" name="attr_height" title="height"/></div>
				<div class="info_label personal-info-label short-label">Weight</div>
				<div class="info_field"><input class="short-field" type="text" name="attr_weight" title="weight"/>lbs</div>
			</div>
		</div>
		<div class="social">
			<div class="personal-info-grid-container">
				<div class="info_label personal-info-label">Background</div>
				<div class="info_field"><input type="text" name="attr_skills" title="skills"/></div>
				<div class="info_label personal-info-label">Motivation</div>
				<div class="info_field"><input type="text" name="attr_motivation" title="motivation"/></div>
				<div class="info_label personal-info-label">Legal Status</div>
				<div class="info_field"><input type="text" name="attr_legal_status" title="legal_status"/></div>
				<div class="info_label personal-info-label">Sec. Clr.</div>
				<div class="info_field"><input class="sheet-number-text" type="text" name="attr_security_clearance" title="security_clearance" readonly/></div>
			</div>
		</div>
		<div class="powers">
			<div class="section-header-label">Abilities</div>
			<div class="powers-grid-container">
				<div class="cps">CPs:</div>
				<div class="power-desc inventing">
					INVENTING: <input class="sheet-number-text" type="text" name="attr_invention_points" title="invention_points" readonly /> 
					Unspent <input class="sheet-number-text" type="text" name="attr_ipoints_remain" title="ipoints_remain" readonly />
				</div>
				<div class="ips">IPs:</div>
			</div>
			<fieldset class="repeating_powers">	
				<div class="powers-grid-container">
					<div class="cps"><input type="number" name="attr_ability_cost" title="ability_cost" value="0"/></div>
					<div class="power-desc">
						<input class="power-desc" type="text" name="attr_ability_desc" title="ability_desc"/>
						<input type="checkbox" name="attr-options-flag" class="stats-toggle" unchecked><span class="stats-toggle pictos-button">y</span>
						<div class="statmod-container">
							<div class="power-detail-container">
								<div class="bc_adj_st statmod-label-cell">ST<br /><input type="number" name="attr_st_adj" title="st_adj" /></div>
								<div class="bc_adj_en statmod-label-cell">EN<br /><input type="number" name="attr_en_adj" title="en_adj" /></div>
								<div class="bc_adj_ag statmod-label-cell">AG<br /><input type="number" name="attr_ag_adj" title="ag_adj" /></div>
								<div class="bc_adj_in statmod-label-cell">IN<br /><input type="number" name="attr_in_adj" title="in_adj" /></div>
								<div class="bc_adj_cl statmod-label-cell">CL<br /><input type="number" name="attr_cl_adj" title="cl_adj" /></div>
								<div class="options_desc statmod-label-cell">Options<br />
									<textarea class="power-options-textarea" name="attr_options" title="options"></textarea>
								</div>

								<div class="stat_adj_phdef statmod-label-cell">Ph Def<br /><input type="number" name="attr_physdef_adj" title="physdef_adj" /></div>
								<div class="stat_adj_mntdef statmod-label-cell">Mnt Def<br /><input type="number" name="attr_mentdef_adj" title="mentdef_adj" /></div>
								<div class="stat_adj_pwr statmod-label-cell">Power<br /><input type="number" name="attr_pwr_adj" title="pwr_adj" /></div>
								<div class="stat_adj_hp statmod-label-cell">Hit Pts<br /><input type="number" name="attr_hp_adj" title="hp_adj" /></div>
								<div class="stat_adj_init statmod-label-cell">Init<br /><input type="number" name="attr_init_adj" title="init_adj" /></div>
								<div class="stat_adj_luck statmod-label-cell">Luck<br /><input type="number" name="attr_luck_adj" title="luck_adj" /></div>
								
								<div class="attack_adj_hdr1 statmod-label-cell">Attack<br />To Hit</div>
								<div class="attack_adj_all_col statmod-label-cell">All<br /><input type="number" name="attr_atk_all_adj" title="atk_all_adj" /></div>
								<div class="attack_adj1_col statmod-label-cell">1<br /><input type="number" name="attr_atk_1_adj" title="atk_1_adj" /></div>
								<div class="attack_adj2_col statmod-label-cell">2<br /><input type="number" name="attr_atk_2_adj" title="atk_2_adj" /></div>
								<div class="attack_adj3_col statmod-label-cell">3<br /><input type="number" name="attr_atk_3_adj" title="atk_3_adj" /></div>
								<div class="attack_adj4_col statmod-label-cell">4<br /><input type="number" name="attr_atk_4_adj" title="atk_4_adj" /></div>
								
								<div class="mods_desc statmod-label-cell">Modifiers<br />
									<textarea class="power-options-textarea" name="attr_modifiers" title="modifiers"></textarea>
								</div>

								<div class="attack_adj_hdr2 statmod-label-cell">Attack<br />To Hit</div>
								<div class="attack_adj5_col statmod-label-cell">5<br /><input type="number" name="attr_atk_5_adj" title="atk_5_adj" /></div>
								<div class="attack_adj6_col statmod-label-cell">6<br /><input type="number" name="attr_atk_6_adj" title="atk_6_adj" /></div>
								<div class="attack_adj7_col statmod-label-cell">7<br /><input type="number" name="attr_atk_7_adj" title="atk_7_adj" /></div>
								<div class="attack_adj8_col statmod-label-cell">8<br /><input type="number" name="attr_atk_8_adj" title="atk_8_adj" /></div>
								<div class="attack_adj9_col statmod-label-cell">9<br /><input type="number" name="attr_atk_9_adj" title="atk_9_adj" /></div>


							</div>
	
						</div>
					</div>
					<div class="ips"><input type="number" name="attr_ip_cost" title="ip_cost" value="0"/></div>
					<div class="actions">
						<input type='checkbox' name='attr_power_active' title='power_active' checked  />
						<button type="roll" name="roll_power_desc" value="&{template:powerdesc} {{desc=@{ability_desc}}} {{options=@{options}}} {{modifiers=@{modifiers}}}" class="tochat"></button>
					</div>

				</div>
			</fieldset>
		</div>
		<div class="stats">
			<div class="bc-grid-container">
				<div class="cost-col bc-label">COST</div>
				<div class="bc-col  bc-label">BC</div>
				<div class="score-col  bc-label">SCORE</div>
				<div class="save-col">&nbsp;</div>
				<div class="roll-col">&nbsp;</div>
			</div>

			<div class="bc-grid-container">
				<div class="cost-col"><input type="number" name="attr_strength_cost" title="strength_cost" value="0"/></div>
				<div class="bc-col bc-label">ST</div>
				<div class="score-col"><input type="text" name="attr_strength_score" title="strength_score" class="bc-number-field" readonly /></div>
				<div class="save-col bc-label">SAVE</div>
				<div class="roll-col">&nbsp;</div>
			</div>
			
			<div class="bc-grid-container">
				<div class="cost-col"><input type="number" name="attr_endurance_cost" title="endurance_cost" value="0"/></div>
				<div class="bc-col bc-label">EN</div>
				<div class="score-col"><input type="text" name="attr_endurance_score" title="endurance_score" class="bc-number-field" readonly /></div>
				<div class="save-col">
					<input type="text" name="attr_endurance_save" title="endurance_save" class="bc-number-field" readonly />		
				</div>
				<div class="roll-col">
					<button type='roll' value='@{character_name} rolls a save against Endurance with [[1d20<?{Endurance Target|@{endurance_save}}]] successes!' name='roll_Endurance_Save'></button>
				</div>
			</div>
			<div class="bc-grid-container">
				<div class="cost-col"><input type="number" name="attr_agility_cost" title="agility_cost" value="0"/></div>
				<div class="bc-col bc-label">AG</div>
				<div class="score-col"><input type="text" name="attr_agility_score" title="agility_score" class="bc-number-field" readonly /></div>
				<div class="save-col">
					<input type="text" name="attr_agility_save" title="agility_save" class="bc-number-field" readonly />
				</div>
				<div class="roll-col">
					<button type='roll' value='@{character_name} rolls a save against Agility with [[1d20<?{Agility Target|@{agility_save}}]] successes!' name='roll_Agility_Save'></button>
				</div>
			</div>
			<div class="bc-grid-container">
				<div class="cost-col"><input type="number" name="attr_intelligence_cost" title="intelligence_cost" value="0"/></div>
				<div class="bc-col bc-label">IN</div>
				<div class="score-col"><input type="text" name="attr_intelligence_score" title="intelligence_score" class="bc-number-field" readonly></div>
				<div class="save-col">
					<input type="text" name="attr_intelligence_save" title="intelligence_save" class="bc-number-field" readonly />
				</div>
				<div class="roll-col">
					<button type='roll' value='@{character_name} rolls a save against Intelligence with [[1d20<?{Intelligence Target|@{intelligence_save}}]] successes!' name='roll_Intelligence_Save'></button>
				</div>
			</div>
			<div class="bc-grid-container">
				<div class="cost-col"><input type="number" name="attr_cool_cost" title="cool_cost" value="0"/></div>
				<div class="bc-col bc-label">CL</div>
				<div class="score-col"><input type="text" name="attr_cool_score" title="cool_score" class="bc-number-field" readonly/></div>
				<div class="save-col">
					<input type="text" name="attr_cool_save" title="cool_save" class="bc-number-field" readonly />
				</div>
				<div class="roll-col">
					<button type='roll' value='@{character_name} rolls a save against Cool with [[1d20<?{Cool Target|@{cool_save}}]] successes!' name='roll_Cool_Save'></button>
				</div>
			</div>		
			
			<br />

			<div class="experience-container">
				<div class="exp-top-label">Power Level</div>
				<div class="exp-tot-label">Exp</div>
			</div>
			<div class="experience-container">
				<div class="main-exp-col"></div>
				<div class="exp-label-col exp-label">Base</div>
				<div class="exp-total-col exp-number"><input type="number" name="attr_exp_base" title="exp_base" /></div>
			</div>
			<div class="experience-container">
				<div class="main-exp-col"></div>
				<div class="exp-label-col exp-label">Spent</div>
				<div class="exp-total-col exp-number"><input  type="number" name="attr_exp_spent" title="exp_spent" /> Earned <input  type="number" name="attr_exp_earned" title="exp_earned" /></div>
			</div>
			<div class="experience-container">
				<div class="main-exp-col"><input  class="number-text" type="text" name="attr_power_level" title="power_level" readonly/></div>
				<div class="exp-label-col exp-label">Total</div>
				<div class="exp-total-col"><input  class="sheet-number-text" type="text" name="attr_exp_total" title="exp_total" readonly/></div>
			</div>
		</div>
		<div class="attacks">
			<div class="attack-container">
				<div class="attack-col">Attack</div>
				<div class="tohit-attrib-col">Attrib</div>
				<div class="tohit-col">To Hit</div>
				<div class="dmg-col">Damage</div>
				<div class="dmgtype-col">Damage Type</div>
				<div class="kb-col">KB?</div>
			</div>
			<fieldset class="repeating_attacks">
				<div class="attack-container">
					<div class="attack-col"><input class="med-field" type="text" name="attr_attack_name" title="attack_name"/></div>
					<div class="tohit-attrib-col">
						<select name="attr-tohit-bc" title="tohit_bc" class="short-select">
							<option value="0" selected>AG</option>
							<option value="1">IN</option>
							<option value="2">CL</option>
						</select>
					</div>
					<div class="tohit-col">
						<input type="text" name="attr_tohit" title="tohit" class="bc-number-field" readonly/>
						<button type='roll' value='@{character_name} attacks @{target|foe|character_name} with @{attack_one} and hits [[1d20<?{Combat Target|@{tohit_one}}]] times!' name='roll_Attack'></button>
					</div>
					<div class="dmg-col">
						<input type="text" name="attr_damage" title="damage" class="med-field"/>
						<button type='roll' value='@{character_name} does [[@{damage_one}+?{Damage Modification|0}]] of @{damagetype_one}. Does it cause knockback? @{knockback_one}' name='roll_Damage'></button>
					</div>
					<div class="dmgtype-col"><input type="text" name="attr_damagetype" title="damagetype" class="med-field"/></div>
					<div class="kb-col">
						<select name="attr-kb" title="kb" class="tiny-select">
							<option>Y</option>
							<option selected>N</option>
						</select>
					</div>
				</div>
			</fieldset>
			<br />
			<div class="protection-container">
				<div class="protect-col">PROTECTION</div>
				<div class="kinetic-col">Kinetic</div>
				<div class="energy-col">Energy</div>
				<div class="bio-col">Bio</div>
				<div class="entropy-col">Entropy</div>
				<div class="psychic-col">Psychic</div>
				<div class="other-col">Other</div>
				<div class="other-desc-col"></div>
			</div>
			<fieldset class="repeating_protection">
				<div class="protection-container">
					<div class="protect-col"><input type="text" name="attr_protection" title="protection" class="med-field"/></div>
					<div class="kinetic-col"><input type="number" name="attr_kinetic" title="kinetic"/></div>
					<div class="energy-col"><input type="number" name="attr_energy" title="energy"/></div>
					<div class="bio-col"><input type="number" name="attr_bio" title="bio"/></div>
					<div class="entropy-col"><input type="number" name="attr_entropy" title="entropy"/></div>
					<div class="psychic-col"><input type="number" name="attr_psychic" title="psychic"/></div>
					<div class="other-col"><input type="number" name="attr_other" title="other"/></div>
					<div class="other-desc-col"><input type="text" name="attr-other-type" title="other-type" class="short-field" /></div>
				</div>
			</fieldset>
			<br />
			<div class="movement-container">
				<div class="move-type-col">MOVEMENT</div>
				<div class="move-amt-col"></div>
			</div>
			<div class="movement-container">
				<div class="move-type-col">Ground</div>
				<div class="move-amt-col"><input  class="short-field" type="text" name="attr_movement_ground" title="movement_ground" value="round((@{strength_score}+@{endurance_score}+@{agility_score})/3)" disabled/></div>
			</div>
			<div class="movement-container">
				<div class="move-type-col">Leaping</div>
				<div class="move-amt-col"><input  class="short-field" type="text" name="attr_movement_leap" title="movement_leap" readonly/></div>
			</div>
			<fieldset class="repeating_movement">
				<div class="movement-container">
					<div class="move-type-col"><input class="med-field" type="text" name="attr_movement_name" title="movement_name"/></div>
					<div class="move-amt-col"><input class="short-field" type="text" name="attr_movement_distance" title="movement_distance"/></div>	
				</div>
			</fieldset>
		</div>
	</div>
	<div>

		<br />
		<div class="section-details">
			<div class="table">
				<div class="table-row">
					<span class="table-data">CARRYING CAPACITY:</span>
					<span class="table-data"><input class="med-field" type="text" name="attr_carry_capacity" title="carry_capacity" readonly /></span>
					<span class="table-data">&emsp;</span>
					<span class="table-data">BASE HTH DAMAGE:</span>
					<span class="table-data"><input class="med-field" type="text" name="attr_hth_damage" title="hth_damage" readonly /></span>
					<span class="table-data">&emsp;</span>
					<span class="table-data">DEFENSES:</span>
					<span class="table-data">&emsp;</span>
					<span class="table-data">Physical:</span>
					<span class="table-data"><input class="number-text" type="text" name="attr_physical_def" title="physical_def" value="(@{agility_save}+@{physical_mod}-10)" disabled/></span>
					<span class="table-data">&emsp;</span>
					<span class="table-data">Mental:</span>
					<span class="table-data"><input class="number-text" type="text" name="attr_mental_def" title="mental_def" value="(@{intelligence_save}+@{mental_mod}-10)" disabled/></span>
				</div>
			</div>
		</div>
		<div class="section-details">
			<div class="table">
				<div class="table-row">
					<span class="table-data">POWER: (<input class="number-text" type="text" name="attr_power_score" title="power_score"/>/<input class="number-text" type="text" name="attr_power_score_max" title="power_score_max" readonly />)</span>
					<span class="table-data">&emsp;</span>
					<span class="table-data">INITIATIVE <input class="short-field" type="text" name="attr_initiative_score" title="initiative_score" readonly /><button type='roll' value='@{selected|token_name} [[ @{initiative_score} &{tracker:-}]]' name='roll_Initiative'></button></span>
					<span class="table-data">&emsp;</span>
					<span class="table-data">Mass <input class="short-field" type="text" name="attr_mass" title="mass" readonly/><button type='roll' value='@{character_name} rolls mass scoring: [[@{mass}]]' name='roll_Mass'></button></span>
					<span class="table-data">&emsp;</span>
					<span class="table-data">Wealth <input class="short-field" type="text" name="attr_wealth" title="wealth"/><button type='roll' value='@{character_name} rolls a wealth check getting: [[@{wealth}]]' name='roll_Wealth'></button></span>
					<span class="table-data">&emsp;</span>
					<span class="table-data">Luck <input class="number-text" type="text" name="attr_luck" title="luck" value="10" readonly/><button type='roll' value='@{character_name} makes a luck check with [[1d20<@{luck}]] successes' name='roll_Luck'></button></span>
				</div>
			</div>
		</div>
		<div class="section-details">
			<div class="table">
				<div class="table-row">
					<span class="table-data">HITS: (<input class="sheet-number-text" type="text" name="attr_hits_score" title="hits_score"/>/<input class="sheet-number-text" type="text" name="attr_hits_score_max" title="hits_score_max" readonly/>)</span>
					<span class="table-data">&emsp;</span>
					<span class="table-data">HEALING: <input class="sheet-number-text" type="text" name="attr_healing_rate" title="healing_rate" readonly/></span>
					<span class="table-data">&emsp;</span>
					<span class="table-data">Profile <input type="number" name="attr_profile" title="personal-info-label" value="1" step=".1"/></span>

				</div>
			</div>
		</div>


		<div class="section-details">
			<div class="table">
				<div class="table-row">
					<span class="table-data">CAPS:</span>
					<span class="table-data">&nbsp;</span>
					<span class="table-data">BCs:</span>
					<span class="table-data"><input type="text" name="attr_bc_score" title="bc_score" class="number-text" readonly/></span>
					<span class="table-data">&nbsp;</span>
					<span class="table-data">Abilty:</span>
					<span class="table-data">&nbsp;</span>
					<span class="table-data"><input type="text" name="attr_ability_score" title="ability_score" class="number-text" readonly/></span>
					<span class="table-data">&nbsp;</span>
					<span class="table-data">Dmg:</span>
					<span class="table-data">&nbsp;</span>
					<span class="table-data"><input type="text" name="attr_dmg_score" title="dmg_score" class="number-text" readonly/></span>
					<span class="table-data">&emsp;</span>
					<span class="table-data">GEAR:</span>
					<span class="table-data">&nbsp;</span>
					<span class="table-data">Break:</span>
					<span class="table-data"><input type="text" name="attr_break_score" title="break_score" class="number-text" readonly/></span>
					<span class="table-data">&nbsp;</span>
					<span class="table-data">Take:</span>
					<span class="table-data"><input type="text" name="attr_take_score" title="take_score" class="number-text" readonly/></span>
					<span class="table-data">&nbsp;</span>
					<span class="table-data">Disarm:</span>
					<span class="table-data"><input type="text" name="attr_disarm_score" title="disarm_score" class="number-text" readonly/></span>
					<span class="table-data">&nbsp;</span>
					<span class="table-data">BC:</span>
					<span class="table-data"><input type="text" name="attr_bcfinal_score" title="bcfinal_score" class="number-text" readonly/></span>
				</div>
			</div>
		</div>
	</div>
</div>
<div class="tab-content veh-tab">
	<div class="section-details">
		<div class="table">
			<div class="table-row">
				<span class="table-data">NAME: <input type="text" name="attr_vehicle_name" title="vehicle_name" /></span>
				<span class="table-data">&nbsp;</span>
				<span class="table-data">MODEL: <input type="text" name="attr_vehicle_model" title="vehicle_model" /></span>
				<span class="table-data">&nbsp;</span>
				<span class="table-data">OPERATOR: <input type="text" name="attr_vehicle_operator" title="vehicle_operator" /></span>
			</div>
		</div>
	</div>
	<div class="section-details">
		<div class="table">
			<div class="table-row">
				<span class="table-data">SYSTEM SPACES: <input class="sheet-number-text" type="text" name="attr_vehicle_spaces" title="vehicle_spaces" readonly /></span>
				<span class="table-data">&nbsp;</span>
				<span class="table-data">PROFILE: <input class="sheet-number-text" type="text" name="attr_vehicle_profile" title="vehicle_profile" readonly /></span>
				<span class="table-data">&nbsp;</span>
				<span class="table-data">WEIGHT: <input class="sheet-number-text" type="text" name="attr_vehicle_weight" title="vehicle_weight" readonly /> lbs</span>
				<span class="table-data">&nbsp;</span>
				<span class="table-data">MASS: <input class="sheet-number-text" type="text" name="attr_vehicle_mass" title="vehicle_mass" readonly /></span>
			</div>
		</div>
	</div>
	<div class="section-details">
		<div class="table">
			<div class="table-row">
				<span class="table-data">ARMOR:</span>
				<span class="table-data">&nbsp;</span>
				<span class="table-data">Kinetic: <input class="sheet-number-text" type="text" name="attr_vehicle_kinetic_armor" title="vehicle_kinetic_armor" readonly /></span>
				<span class="table-data">&nbsp;</span>
				<span class="table-data">Energy: <input class="sheet-number-text" type="text" name="attr_vehicle_energy_armor" title="vehicle_energy_armor" readonly /></span>
				<span class="table-data">&nbsp;</span>
				<span class="table-data">Biochem: <input class="sheet-number-text" type="text" name="attr_vehicle_bio_armor" title="vehicle_bio_armor" readonly /></span>
				<span class="table-data">&nbsp;</span>
				<span class="table-data">Entropy: <input class="sheet-number-text" type="text" name="attr_vehicle_entropy_armor" title="vehicle_entropy_armor" readonly /></span>
				<span class="table-data">&nbsp;</span>
				<span class="table-data">Psychic: <input class="sheet-number-text" type="text" name="attr_vehicle_psychic_armor" title="vehicle_psychic_armor" readonly /></span>
			</div>
		</div>
	</div>
	
</div>

<rolltemplate class="sheet-rolltemplate-powerdesc">
    <div class="container">
		<div class="header">Ability</div>
		<div class="row"><span>{{desc}}</span></div>
		<div class="header">Options</div>
		<div class="row"><span>{{options}}</span></div>
		<div class="header">Modifiers</div>
		<div class="row"><span>{{modifiers}}</span></div>
	</div>
</rolltemplate>


<script type="text/worker">
	/* ===== PARAMETERS ==========
	destinations = the name of the attribute that stores the total quantity
			can be a single attribute, or an array: ['total_cost', 'total_weight']
			If more than one, the matching fields must be in the same order. 
		section = name of repeating fieldset, without the repeating_
		fields = the name of the attribute field to be summed
			  destination and fields both can be a single attribute: 'weight'
			  or an array of attributes: ['weight','number','equipped']
	*/
	const repeatingSum = (destinations, section, fields) => {
		if (!Array.isArray(destinations)) destinations = [destinations.replace(/\s/g, '').split(',')];
		if (!Array.isArray(fields)) fields = [fields.replace(/\s/g, '').split(',')];
		getSectionIDs(`repeating_${section}`, idArray => {
			const attrArray = idArray.reduce((m, id) => [...m, ...(fields.map(field => `repeating_${section}_${id}_${field}`))], []);
			getAttrs([...attrArray], v => {
				const getValue = (section, id, field) => v[`repeating_${section}_${id}_${field}`] === 'on' ? 1 : parseFloat(v[`repeating_${section}_${id}_${field}`]) || 0;
				const commonMultipliers = (fields.length <= destinations.length) ? [] : fields.splice(destinations.length, fields.length - destinations.length);
				const output = {};
				destinations.forEach((destination, index) => {
					output[destination] = idArray.reduce((total, id) => total + getValue(section, id, fields[index]) * commonMultipliers.reduce((subtotal, mult) => subtotal * getValue(section, id, mult), 1), 0);
				});
				setAttrs(output);
			}); 
		}); 
	};

	function simplifyDice(rollText) {
        const diceRE = /(?=[+-])/
        let finalAdj = 0;
        let dice = '';
        let rollsByDie = [];
        let rolls = rollText.split(diceRE);
        let simplifiedRoll = '';

        rolls.forEach(section => {
            section = section.replace('+', '');
            dice = section.split('d');
            
            if (dice.length == 1) {
                finalAdj = finalAdj + parseInt(dice[0],10);
            } else {
                let idx = rollsByDie.findIndex((item) => item.dieSize === dice[1]);
                if (idx == -1) {
                    rollsByDie.push({dieCount: parseInt(dice[0],10) || 1, dieSize: dice[1]});
                } else {
                    rollsByDie[idx].dieCount += (parseInt(dice[0],10) || 1);
                }
            }
        });

        // sort it by die size
        rollsByDie.sort(function(a,b) {
            return parseInt(a.dieSize, 10) - parseInt(b.dieSize, 10);
        })

        rollsByDie.forEach(dieRoll => {
            if (dieRoll.dieCount != 0)
            {
                simplifiedRoll += ((simplifiedRoll.length > 0 && dieRoll.dieCount > 0) ? '+' : '') + dieRoll.dieCount + 'd' + dieRoll.dieSize;
            }
        })
        if (finalAdj != 0)
        {
            simplifiedRoll += ((finalAdj > 0) ? '+' : '') + finalAdj;
        }

        return simplifiedRoll;
	}
	
	

	const soManyStats = [
		"strength_score",
		"endurance_score",
		"agility_score",
		"intelligence_score",
		"cool_score",
		"init_adj_total",
		"hp_adj_total",
		"pwr_adj_total",
		"luck_adj_total",
		"weight",
		"ability_cp_total",
		"strength_cost",
		"endurance_cost",
		"agility_cost",
		"intelligence_cost",
		"cool_cost",
		"exp_base",
		"exp_spent",
		"exp_earned",
		"atk_all_total",
		"atk_1_total",
		"atk_2_total",
		"atk_3_total",
		"atk_4_total",
		"atk_5_total",
		"atk_6_total",
		"atk_7_total",
		"atk_8_total",
		"atk_9_total"
		];
		
	const soManyChanges = soManyStats.map(stat => `change:${stat}`).join(' ');
	on(`${soManyChanges}`, function() {
	getAttrs(soManyStats, function(v) {
		let statTable = [
			{min: 0, max: 0, carry: 8, hth_init: 'd2-1', save: 6, hits_st: -3, hits_en: -5, hits_ag: -2, hits_cl: -1, heal: .2},
			{min: 1, max: 1, carry: 10, hth_init: 'd2-1', save: 7, hits_st: -3, hits_en: -5, hits_ag: -2, hits_cl: -1, heal: .3},
			{min: 2, max: 2, carry: 12, hth_init: 'd2-1', save: 7, hits_st: -3, hits_en: -5, hits_ag: -2, hits_cl: -1, heal: .3},
			{min: 3, max: 5, carry: 15, hth_init: 'd2', save: 8, hits_st: -2, hits_en: -3, hits_ag: -1, hits_cl: -0, heal: .5},
			{min: 6, max: 8, carry: 30, hth_init: 'd3', save: 9,  hits_st: 0, hits_en: -1, hits_ag: 0, hits_cl: 1, heal: .8},
			{min: 9, max: 11, carry: 60, hth_init: 'd4', save: 10, hits_st: 1, hits_en: 1, hits_ag: 1, hits_cl: 1, heal: 1},
			{min: 12, max: 14, carry: 120, hth_init: 'd6', save: 11, hits_st: 3, hits_en: 3, hits_ag: 2, hits_cl: 2, heal: 1.6},
			{min: 15, max: 17, carry: 240, hth_init: 'd6+1', save: 11, hits_st: 5, hits_en: 6, hits_ag: 3, hits_cl: 2, heal: 2.2},
			{min: 18, max: 20, carry: 480, hth_init: 'd8+1', save: 12, hits_st: 6, hits_en: 8, hits_ag: 5, hits_cl: 3, heal: 2.8},
			{min: 21, max: 23, carry: 960, hth_init: 'd10+1', save: 12, hits_st: 8, hits_en: 10, hits_ag: 6, hits_cl: 3, heal: 3.4},
			{min: 24, max: 26, carry: 1920, hth_init: '2d6', save: 13, hits_st: 10, hits_en: 13, hits_ag: 7, hits_cl: 5, heal: 3.9},
			{min: 27, max: 29, carry: 3840, hth_init: 'd6+d8', save: 13, hits_st: 12, hits_en: 15, hits_ag: 8, hits_cl: 5, heal: 4.5},
			{min: 30, max: 32, carry: 7680, hth_init: '2d8', save: 14, hits_st: 14, hits_en: 17, hits_ag: 9, hits_cl: 5, heal: 5.1},
			{min: 33, max: 35, carry: 15360, hth_init: 'd8+d10', save: 14, hits_st: 16, hits_en: 20, hits_ag: 10, hits_cl: 6, heal: 5.7},
			{min: 36, max: 38, carry: 30720, hth_init: '2d10', save: 15, hits_st: 17, hits_en: 22, hits_ag: 12, hits_cl: 6, heal: 6.3},
			{min: 39, max: 41, carry: 61440, hth_init: 'd10+d12', save: 15, hits_st: 19, hits_en: 25, hits_ag: 13, hits_cl: 7, heal: 6.9},
			{min: 42, max: 44, carry: 122880, hth_init: '2d12', save: 16, hits_st: 21, hits_en: 27, hits_ag: 14, hits_cl: 7, heal: 7.5},
			{min: 45, max: 47, carry: 245760, hth_init: '3d8', save: 16, hits_st: 23, hits_en: 29, hits_ag: 15, hits_cl: 8, heal: 8.1},
			{min: 48, max: 50, carry: 491520, hth_init: '2d8+d10', save: 17, hits_st: 25, hits_en: 32, hits_ag: 16, hits_cl: 9, heal: 8.7},
			{min: 51, max: 53, carry: 983040, hth_init: 'd8+2d10', save: 17, hits_st: 27, hits_en: 34, hits_ag: 17, hits_cl: 9, heal: 9.2},
			{min: 54, max: 56, carry: 1966080, hth_init: '3d10', save: 18, hits_st: 28, hits_en: 36, hits_ag: 19, hits_cl: 10, heal: 9.8},
			{min: 57, max: 59, carry: 3932160, hth_init: '2d10+d12', save: 18, hits_st: 30, hits_en: 39, hits_ag: 20, hits_cl: 10, heal: 10.4},
			{min: 60, max: 62, carry: 7864320, hth_init: 'd10+2d12', save: 19, hits_st: 32, hits_en: 41, hits_ag: 21, hits_cl: 11, heal: 11},
			{min: 63, max: 65, carry: 15728640, hth_init: '3d12', save: 19, hits_st: 34, hits_en: 43, hits_ag: 22, hits_cl: 12, heal: 11.6},
			{min: 66, max: 68, carry: 31457280, hth_init: '3d12+1', save: 20, hits_st: 36, hits_en: 46, hits_ag: 23, hits_cl: 12, heal: 12.2},
			{min: 69, max: 71, carry: 62914560, hth_init: '3d12+2', save: 20, hits_st: 38, hits_en: 48, hits_ag: 25, hits_cl: 13, heal: 12.8},
			{min: 72, max: 74, carry: 125829120, hth_init: '4d10', save: 21, hits_st: 39, hits_en: 50, hits_ag: 26, hits_cl: 13, heal: 13.4},
			{min: 75, max: 77, carry: 251658240, hth_init: '3d10+d12', save: 21, hits_st: 41, hits_en: 53, hits_ag: 27, hits_cl: 14, heal: 14},
			{min: 78, max: 80, carry: 503316480, hth_init: '2d10+2d12', save: 22, hits_st: 43, hits_en: 55, hits_ag: 28, hits_cl: 15, heal: 14.5},
			{min: 81, max: 83, carry: 1006632960, hth_init: 'd10+3d12', save: 22, hits_st: 45, hits_en: 58, hits_ag: 29, hits_cl: 15, heal: 15.1},
			{min: 84, max: 86, carry: 2013265920, hth_init: '4d12', save: 23, hits_st: 47, hits_en: 60, hits_ag: 30, hits_cl: 16, heal: 15.7},
			{min: 87, max: 89, carry: 4026531840, hth_init: '4d12+1', save: 23, hits_st: 48, hits_en: 62, hits_ag: 32, hits_cl: 16, heal: 16.3},
			{min: 90, max: 92, carry: 8053063680, hth_init: '5d10', save: 24, hits_st: 50, hits_en: 65, hits_ag: 33, hits_cl: 17, heal: 16.9},
			{min: 93, max: 95, carry: 16106127360, hth_init: '4d10+d12', save: 24, hits_st: 52, hits_en: 67, hits_ag: 34, hits_cl: 17, heal: 17.5},
			{min: 96, max: 98, carry: 32212254720, hth_init: '3d10+2d12', save: 25, hits_st: 54, hits_en: 69, hits_ag: 35, hits_cl: 18, heal: 18.1}
		];

		let stResult = statTable.filter(tableRow => (tableRow.min <= v.strength_score && tableRow.max >= v.strength_score));
		let enResult = statTable.filter(tableRow => (tableRow.min <= v.endurance_score && tableRow.max >= v.endurance_score));
		let agResult = statTable.filter(tableRow => (tableRow.min <= v.agility_score && tableRow.max >= v.agility_score));
		let inResult = statTable.filter(tableRow => (tableRow.min <= v.intelligence_score && tableRow.max >= v.intelligence_score));
		let clResult = statTable.filter(tableRow => (tableRow.min <= v.cool_score && tableRow.max >= v.cool_score));
		let leap = (parseInt(v.weight,10) > 0) ? Math.floor(stResult[0].carry / parseInt(v.weight,10)) : '';
		let exp_tot_spent = (parseInt(v.exp_base,10) || 0) + (parseInt(v.exp_spent,10) || 0)
		let mass_roll = null;

		if (parseInt(v.weight,10) > 0) {
			let mass_val = parseInt(v.weight,10) /2;

			var closestValue = Infinity;
			var closestIndex = -1;
			for (var i = 0; i < statTable.length; ++i) {
			  var diff = Math.abs(statTable[i].carry - mass_val);
			  if (diff < closestValue) {
				closestValue = diff;
				closestIndex = i;
			  }
			}
			mass_roll = statTable[closestIndex].hth_init;
		}

		
		setAttrs({
			carry_capacity: stResult[0].carry,
			endurance_save: enResult[0].save,
			agility_save: agResult[0].save,
			intelligence_save: inResult[0].save,
			cool_save: clResult[0].save,
			hth_damage: stResult[0].hth_init,
			initiative_score: simplifyDice(clResult[0].hth_init + '+' + v.init_adj_total),
			luck: 10+(parseInt(v.luck_adj_total,10) || 0),
			power_score_max: (parseInt(v.strength_score,10) || 0) + (parseInt(v.endurance_score,10) || 0) + (parseInt(v.agility_score,10) || 0) + (parseInt(v.intelligence_score,10) || 0) + (parseInt(v.pwr_adj_total,10) || 0),
			hits_score_max: stResult[0].hits_st + enResult[0].hits_en + agResult[0].hits_ag + clResult[0].hits_cl + (parseInt(v.hp_adj_total,10) || 0),
			movement_leap: leap,
			healing_rate: enResult[0].heal,
			power_level: (parseInt(v.ability_cp_total,10) || 0) + (parseInt(v.strength_cost,10) || 0) + (parseInt(v.agility_cost,10) || 0) + (parseInt(v.endurance_cost,10) || 0) + (parseInt(v.intelligence_cost,10) || 0) + (parseInt(v.cool_cost,10) || 0),
			bc_score: Math.floor((exp_tot_spent/5)+10),
			ability_score: Math.floor(exp_tot_spent/5),
			dmg_score: Math.floor((exp_tot_spent/12.5)+3),
			break_score: Math.round((exp_tot_spent/25)+5),
			take_score: Math.round((exp_tot_spent/25)+6),
			disarm_score: Math.round((exp_tot_spent/25)+3),
			bcfinal_score: Math.round((exp_tot_spent/15)+6),
			exp_total: (parseInt(v.exp_base,10) || 0) + (parseInt(v.exp_spent,10) || 0),
			mass: mass_roll,
			security_clearance: clResult[0].save + inResult[0].save + Math.floor((v.exp_earned || 0)/5) -20
		});


		getSectionIDsOrdered('attacks', function (ids) {
			const toHitValArray = [];
			const toHitStatArray = [];

			console.log('==== ids');
			console.log(ids);
			
			if (ids.length > 0) {
				ids.forEach(id => toHitValArray.push(
					`repeating_attacks_${id}_tohit`
				));
				ids.forEach(id => toHitStatArray.push(
					`repeating_attacks_${id}_tohit_bc`
				));

				ids.forEach(function(id, index) {
					console.log('Attack ' + index+1 + '= ' + eval(`v.atk_${index+1}_total`));
				});
			}

			console.log('==== toHitValArray');
			console.log(toHitValArray);
			console.log('==== toHitStatArray');
			console.log(toHitStatArray);
		});

		
	});
});

 

	["strength",  "endurance",   "agility",  "intelligence",  "cool"].forEach(stat => {
		let stat_cost = `${stat}_cost`, stat_adj = (stat == 'cool') ? `cl_adj_total` : `${stat.slice(0,2)}_adj_total`;
		on(`change:${stat_cost} change:${stat_adj}`, function() {
			getAttrs([stat_cost, stat_adj], function(v) {
				let cost = +v[stat_cost] ||0;
				let adj =  +v[stat_adj] ||0;
				let score = cost + adj;
				setAttrs({
					[`${stat}_score`]: score
				});
			});
		});
	});
	


	on('change:repeating_powers remove:repeating_powers', function() {
		repeatingSum(["abilityip_total", "st_adj_total", "en_adj_total", "ag_adj_total", "in_adj_total", "cl_adj_total","init_adj_total", "pwr_adj_total", 
		"hp_adj_total", "luck_adj_total", "ability_cp_total","atk_all_total","atk_1_total","atk_2_total","atk_3_total","atk_4_total","atk_5_total",
		"atk_6_total","atk_7_total","atk_8_total","atk_9_total"],
        "powers",
		[
		"ip_cost",
		["st_adj","power_active"],
		["en_adj", "power_active"],
		["ag_adj", "power_active"],
		["in_adj", "power_active"],
		["cl_adj", "power_active"],
		["init_adj","power_active"],
		["pwr_adj", "power_active"],
		["hp_adj","power_active"],
		["luck_adj","power_active"],
		"ability_cost",
		["atk_all_adj","power_active"],
		["atk_1_adj","power_active"],
		["atk_2_adj","power_active"],
		["atk_3_adj","power_active"],
		["atk_4_adj","power_active"],
		["atk_5_adj","power_active"],
		["atk_6_adj","power_active"],
		["atk_7_adj","power_active"],
		["atk_8_adj","power_active"],
		["atk_9_adj","power_active"]
		]);
	});

	function findClosest (value) {
		// By default that will be a big number
		var closestValue = Infinity;
		// We will store the index of the element
		var closestIndex = -1;
		for (var i = 0; i < array.length; ++i) {
		  var diff = Math.abs(array[i].carry - value);
		  if (diff < closestValue) {
			closestValue = diff;
			closestIndex = i;
		  }
		}
		return closestIndex;
	  }

	  var getSectionIDsOrdered = function (sectionName, callback) {
		'use strict';
		getAttrs([`_reporder_${sectionName}`], function (v) {
		  getSectionIDs(sectionName, function (idArray) {
			let reporderArray = v[`_reporder_${sectionName}`] ? v[`_reporder_${sectionName}`].toLowerCase().split(',') : [],
			  ids = [...new Set(reporderArray.filter(x => idArray.includes(x)).concat(idArray))];
			callback(ids);
		  });
		});
	  };

</script>
