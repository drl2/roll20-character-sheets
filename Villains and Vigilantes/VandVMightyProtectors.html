<div class="tab-spacer">&nbsp;</div>
<input type="radio" name="attr_tab" class="tab char-tab" value="1" checked="checked" /> <span class="sheet-tab">Character</span>
<input type="radio" name="attr_tab" class="tab veh-tab" value="2" /> <span class="sheet-tab">Vehicle</span>



<div class="tab-content char-tab overall-wrapper">
	<div class="main-grid-container">
		<div class="cultural">
			<div class="personal-info-grid-container">
				<div class="info_label personal-info-label">True ID</div>
				<div class="info_field"><input type="text" name="attr_identity-name" title="identity-name"/></div>
				<div class="info_label personal-info-label">Side</div>
				<div class="info_field"><input type="text" name="attr_side" title="side" /></div>
				<div class="info_label personal-info-label">Species</div>
				<div class="info_field"><input type="text" name="attr_species" title="species" /></div>
				<div class="info_label personal-info-label">Birthplace</div>
				<div class="info_field"><input type="text" name="attr_birthplace" title="birthplace" /></div>
				<div class="info_label personal-info-label">Culture</div>
				<div class="info_field"><input type="text" name="attr_culture" title="culture"/></div>
				<div class="info_label personal-info-label">Origin Type</div>
				<div class="info_field"><input type="text" name="attr_origin_type" title="origin_type" /></div>
			</div>
		</div>
		<div class="physical">
			<div class="personal-info-grid-container">
				<div class="info_label personal-info-label short-label">Gender</div>
				<div class="info_field"><input class="med-field" type="text" name="attr_gender" title="gender" /></div>
				<div class="info_label personal-info-label short-label">Age</div>
				<div class="info_field"><input class="short-field" type="text" name="attr_age" title="age" /></div>
				<div class="info_label personal-info-label short-label">Height</div>
				<div class="info_field"><input class="short-field" type="text" name="attr_height" title="height"/></div>
				<div class="info_label personal-info-label short-label">Weight</div>
				<div class="info_field"><input class="short-field" type="text" name="attr_weight" title="weight"/></div>
			</div>
		</div>
		<div class="social">
			<div class="personal-info-grid-container">
				<div class="info_label personal-info-label">Background</div>
				<div class="info_field"><input type="text" name="attr_skills" title="skills"/></div>
				<div class="info_label personal-info-label">Motivation</div>
				<div class="info_field"><input type="text" name="attr_motivation" title="motivation"/></div>
				<div class="info_label personal-info-label">Legal Status</div>
				<div class="info_field"><input type="text" name="attr_legal_status" title="legal_status"/></div>
				<div class="info_label personal-info-label">Sec. Clr.</div>
				<div class="info_field"><input class="sheet-number-text" type="text" name="attr_security_clearance" title="security_clearance" value="round(@{intelligence_score} + @{cool_score} + (@{exp_earned}/5) -20)" disabled/></div>
			</div>
		</div>
		<div class="powers">
			<div class="section-header-label">Abilities</div>
			<div class="powers-grid-container">
				<div class="cps">CPs:</div>
				<div class="power-desc inventing">
					INVENTING: <input class="sheet-number-text" type="text" name="attr_invention_points" title="invention_points" value="round(@{intelligence_score} / 2)" disabled/> 
					Unspent <input class="sheet-number-text" type="text" name="attr_ipoints_remain" title="ipoints_remain" value="@{invention_points}-@{abilityip_total}" disabled/>
				</div>
				<div class="ips">IPs:</div>
			</div>
			<fieldset class="repeating_powers">	
				<div class="powers-grid-container">
					<div class="cps"><input type="number" name="attr_ability_cost" title="ability_cost" value="0"/></div>
					<div class="power-desc">
						<input class="power-desc" type="text" name="attr_ability_desc" title="ability_desc"/>
						<input type="checkbox" name="attr-options-flag" class="stats-toggle" unchecked><span class="stats-toggle pictos-button">y</span>
						<div class="statmod-container">
							<table> <!-- using table because it's really just a table -->
								<tr>
									<th class="statmod-label-cell">ST</th>
									<th class="statmod-label-cell">EN</th>
									<th class="statmod-label-cell">AG</th>
									<th class="statmod-label-cell">IN</th>
									<th class="statmod-label-cell">CL</th>
									<th class="statmod-label-cell">Ph Def</th>
									<th class="statmod-label-cell">Mnt Def</th>
									<th class="statmod-label-cell">Power</th>
									<th class="statmod-label-cell">Hit Pts</th>
									<th class="statmod-label-cell">Init</th>
									<th class="statmod-label-cell">Luck</th>
								</tr>
								<tr>
									<td>
										<input type="number" name="attr_st_adj" title="st_adj" />
									</td>
									<td>
										<input type="number" name="attr_en_adj" title="en_adj" />
									</td>
									<td>
										<input type="number" name="attr_ag_adj" title="ag_adj" />
									</td>
									<td>
										<input type="number" name="attr_in_adj" title="in_adj" />
									</td>
									<td>
										<input type="number" name="attr_cl_adj" title="cl_adj" />
									</td>
									<td>
										<input type="number" name="attr_physdef_adj" title="physdef_adj" />
									</td>
									<td>
										<input type="number" name="attr_mentdef_adj" title="mentdef_adj" />
									</td>
									<td>
										<input type="number" name="attr_pwr_adj" title="pwr_adj" />
									</td>
									<td>
										<input type="number" name="attr_hp_adj" title="hp_adj" />
									</td>
									<td>
										<input type="number" name="attr_init_adj" title="init_adj" />
									</td>
									<td>
										<input type="number" name="attr_luck_adj" title="luck_adj" />
									</td>
								</tr>
								<tr><td colspan=11>&nbsp;</td></tr>
								<tr>
									<th class="statmod-label-cell">Attack</th>
									<th class="statmod-label-cell">All</th>
									<th class="statmod-label-cell">1</th>
									<th class="statmod-label-cell">2</th>
									<th class="statmod-label-cell">3</th>
									<th class="statmod-label-cell">4</th>
									<th class="statmod-label-cell">5</th>
									<th class="statmod-label-cell">6</th>
									<th class="statmod-label-cell"></th>
									<th class="statmod-label-cell"></th>
									<th class="statmod-label-cell"></th>
								</tr>
								<tr>
									<td class="statmod-label-cell">To Hit</td>
									<td>
										<input type="number" name="attr_atk_all_adj" title="atk_all_adj" />
									</td>
									<td>
										<input type="number" name="attr_atk_1_adj" title="atk_1_adj" />
									</td>
									<td>
										<input type="number" name="attr_atk_2_adj" title="atk_2_adj" />
									</td>
									<td>
										<input type="number" name="attr_atk_3_adj" title="atk_3_adj" />
									</td>
									<td>
										<input type="number" name="attr_atk_4_adj" title="atk_4_adj" />
									</td>
									<td>
										<input type="number" name="attr_atk_5_adj" title="atk_5_adj" />
									</td>
									<td>
										<input type="number" name="attr_atk_6_adj" title="atk_6_adj" />
									</td>
									<td></td><td></td><td></td>
								</tr>
							</table>
	
						</div>
					</div>
					<div class="ips"><input type="number" name="attr_ip_cost" title="ip_cost" value="0"/></div>
					<div class="actions">
						<button type="roll" name="roll_power_desc" value="&{template:powerdesc} {{desc=@{ability_desc}}}" class="tochat"></button>
					</div>

				</div>
			</fieldset>
		</div>
		<div class="stats">
			<div class="bc-grid-container">
				<div class="cost-col bc-label">COST</div>
				<div class="bc-col  bc-label">BC</div>
				<div class="score-col  bc-label">SCORE</div>
				<div class="save-col">&nbsp;</div>
				<div class="roll-col">&nbsp;</div>
			</div>

			<div class="bc-grid-container">
				<div class="cost-col"><input type="number" name="attr_strength_cost" title="strength_cost" value="0"/></div>
				<div class="bc-col bc-label">ST</div>
				<div class="score-col"><input type="text" name="attr_strength_score" title="strength_score" class="bc-number-field" disabled value="(@{strength_cost}+@{st_adj_total})"/></div>
				<div class="save-col bc-label">SAVE</div>
				<div class="roll-col">&nbsp;</div>
			</div>
			
			<div class="bc-grid-container">
				<div class="cost-col"><input type="number" name="attr_endurance_cost" title="endurance_cost" value="0"/></div>
				<div class="bc-col bc-label">EN</div>
				<div class="score-col"><input type="text" name="attr_endurance_score" title="endurance_score" class="bc-number-field" disabled value="(@{endurance_cost}+@{en_adj_total})"/></div>
				<div class="save-col">
					<input type="text" name="attr_endurance_save" title="endurance_save" class="bc-number-field" disabled value="@{hid_en_save}"/><input type="hidden" name="attr_hid_en_save" title="hid_en_save">
				</div>
				<div class="roll-col">
					<button type='roll' value='@{character_name} rolls a save against Endurance with [[1d20<?{Endurance Target|@{endurance_save}}]] successes!' name='roll_Endurance_Save'></button>
				</div>
			</div>
			<div class="bc-grid-container">
				<div class="cost-col"><input type="number" name="attr_agility_cost" title="agility_cost" value="0"/></div>
				<div class="bc-col bc-label">AG</div>
				<div class="score-col"><input type="text" name="attr_agility_score" title="agility_score" class="bc-number-field" disabled value="(@{agility_cost}+@{ag_adj_total})"/></div>
				<div class="save-col">
					<input type="text" name="attr_agility_save" title="agility_save" class="bc-number-field" disabled value="@{hid_ag_save}"/><input type="hidden" name="attr_hid_ag_save" title="hid_ag_save">
				</div>
				<div class="roll-col">
					<button type='roll' value='@{character_name} rolls a save against Agility with [[1d20<?{Agility Target|@{agility_save}}]] successes!' name='roll_Agility_Save'></button>
				</div>
			</div>
			<div class="bc-grid-container">
				<div class="cost-col"><input type="number" name="attr_intelligence_cost" title="intelligence_cost" value="0"/></div>
				<div class="bc-col bc-label">IN</div>
				<div class="score-col"><input type="text" name="attr_intelligence_score" title="intelligence_score" class="bc-number-field" disabled value="(@{intelligence_cost}+@{in_adj_total})"/></div>
				<div class="save-col">
					<input type="text" name="attr_intelligence_save" title="intelligence_save" class="bc-number-field" disabled value="@{hid_in_save}"/><input type="hidden" name="attr_hid_in_save" title="hid_in_save">
				</div>
				<div class="roll-col">
					<button type='roll' value='@{character_name} rolls a save against Intelligence with [[1d20<?{Intelligence Target|@{intelligence_save}}]] successes!' name='roll_Intelligence_Save'></button>
				</div>
			</div>
			<div class="bc-grid-container">
				<div class="cost-col"><input type="number" name="attr_cool_cost" title="cool_cost" value="0"/></div>
				<div class="bc-col bc-label">CL</div>
				<div class="score-col"><input type="text" name="attr_cool_score" title="cool_score" class="bc-number-field" disabled value="(@{cool_cost}+@{cl_adj_total})"/></div>
				<div class="save-col">
					<input type="text" name="attr_cool_save" title="cool_save" class="bc-number-field" disabled value="@{hid_cl_save}"/><input type="hidden" name="attr_hid_cl_save" title="hid_cl_save">
				</div>
				<div class="roll-col">
					<button type='roll' value='@{character_name} rolls a save against Cool with [[1d20<?{Cool Target|@{cool_save}}]] successes!' name='roll_Cool_Save'></button>
				</div>
			</div>		
			
			<br />

			<div class="experience-container">
				<div class="exp-top-label">Power Level</div>
				<div class="exp-tot-label">Exp</div>
			</div>
			<div class="experience-container">
				<div class="main-exp-col"><input  class="number-text" type="text" name="attr_power-level" title="power-level" value="(@{abilitycp_total}+@{strength_cost}+@{endurance_cost}+@{agility_cost}+@{intelligence_cost}+@{cool_cost} )" disabled/></div>
				<div class="exp-label-col exp-label">Base</div>
				<div class="exp-total-col exp-number"><input type="number" name="attr_exp_base" title="exp_base" /></div>
			</div>
			<div class="experience-container">
				<div class="main-exp-col"></div>
				<div class="exp-label-col exp-label">Earned</div>
				<div class="exp-total-col exp-number"><input  type="number" name="attr_exp_earned" title="exp_earned" /></div>
			</div>
			<div class="experience-container">
				<div class="main-exp-col"></div>
				<div class="exp-label-col exp-label">Total</div>
				<div class="exp-total-col"><input  class="sheet-number-text" type="text" name="attr_exp_total" title="exp_total" value="(@{exp_earned}+@{exp_base})" disabled/></div>
			</div>
		</div>
		<div class="attacks">
			<div class="attack-container">
				<div class="attack-col">Attack</div>
				<div class="tohit-attrib-col">Attrib</div>
				<div class="tohit-col">To Hit</div>
				<div class="dmg-col">Damage</div>
				<div class="dmgtype-col">Damage Type</div>
				<div class="kb-col">KB?</div>
			</div>
			<fieldset class="repeating_attacks">
				<div class="attack-container">
					<div class="attack-col"><input class="med-field" type="text" name="attr_attack_name" title="attack_name"/></div>
					<div class="tohit-attrib-col">
						<select name="attr-tohit-bc" title="tohit_bc" class="short-select">
							<option value="0" selected>AG</option>
							<option value="1">IN</option>
							<option value="2">CL</option>
						</select>
					</div>
					<div class="tohit-col">
						<input type="text" name="attr_tohit" title="tohit" class="bc-number-field" disabled/>
						<button type='roll' value='@{character_name} attacks @{target|foe|character_name} with @{attack_one} and hits [[1d20<?{Combat Target|@{tohit_one}}]] times!' name='roll_Attack'></button>
					</div>
					<div class="dmg-col">
						<input type="text" name="attr_damage" title="damage" class="med-field"/>
						<button type='roll' value='@{character_name} does [[@{damage_one}+?{Damage Modification|0}]] of @{damagetype_one}. Does it cause knockback? @{knockback_one}' name='roll_Damage'></button>
					</div>
					<div class="dmgtype-col"><input type="text" name="attr_damagetype" title="damagetype" class="med-field"/></div>
					<div class="kb-col">
						<select name="attr-kb" title="kb" class="tiny-select">
							<option>Y</option>
							<option selected>N</option>
						</select>
					</div>
				</div>
			</fieldset>
			<br />
			<div class="protection-container">
				<div class="protect-col">PROTECTION</div>
				<div class="kinetic-col">Kinetic</div>
				<div class="energy-col">Energy</div>
				<div class="bio-col">Bio</div>
				<div class="entropy-col">Entropy</div>
				<div class="psychic-col">Psychic</div>
				<div class="other-col">Other</div>
				<div class="other-desc-col"></div>
			</div>
			<fieldset class="repeating_protection">
				<div class="protection-container">
					<div class="protect-col"><input type="text" name="attr_protection" title="protection" class="med-field"/></div>
					<div class="kinetic-col"><input type="number" name="attr_kinetic" title="kinetic"/></div>
					<div class="energy-col"><input type="number" name="attr_energy" title="energy"/></div>
					<div class="bio-col"><input type="number" name="attr_bio" title="bio"/></div>
					<div class="entropy-col"><input type="number" name="attr_entropy" title="entropy"/></div>
					<div class="psychic-col"><input type="number" name="attr_psychic" title="psychic"/></div>
					<div class="other-col"><input type="number" name="attr_other" title="other"/></div>
					<div class="other-desc-col"><input type="text" name="attr-other-type" title="other-type" class="short-field" /></div>
				</div>
			</fieldset>
		</div>
	</div>
	<div>

		<br />
		<div class="section-details">
			<div class="table">
				<div class="table-row">
					<span class="table-data">CARRYING CAPACITY:</span>
					<span class="table-data"><input class="med-field" type="text" name="attr_carry_capacity" title="carry_capacity" disabled value="@{hid_carry}"/><input type="hidden" name="attr_hid_carry" title="hid_carry"></span>
					<span class="table-data">&emsp;</span>
					<span class="table-data">BASE HTH DAMAGE:</span>
					<span class="table-data"><input class="med-field" type="text" name="attr_hth_damage" title="hth_damage"/></span>
					<span class="table-data">&emsp;</span>
					<span class="table-data">DEFENSES:</span>
					<span class="table-data">&emsp;</span>
					<span class="table-data">Physical:</span>
					<span class="table-data"><input class="number-text" type="text" name="attr_physical_def" title="physical_def" value="(@{agility_save}+@{physical_mod}-10)" disabled/></span>
					<span class="table-data">&emsp;</span>
					<span class="table-data">Mental:</span>
					<span class="table-data"><input class="number-text" type="text" name="attr_mental_def" title="mental_def" value="(@{intelligence_save}+@{mental_mod}-10)" disabled/></span>
				</div>
			</div>
		</div>
		<div class="section-details">
			<div class="table">
				<div class="table-row">
					<span class="table-data">INITIATIVE <input class="short-field" type="text" name="attr_initiative_score" title="initiative_score" /><button type='roll' value='@{selected|token_name} [[ @{initiative_score} &{tracker:-}]]' name='roll_Initiative'></button>
					<span class="table-data">&emsp;</span>
					<span class="table-data">Mass <input class="short-field" type="text" name="attr_mass" title="mass"/><button type='roll' value='@{character_name} rolls mass scoring: [[@{mass}]]' name='roll_Mass'></button></span>
					<span class="table-data">&emsp;</span>
					<span class="table-data">Wealth <input class="short-field" type="text" name="attr_wealth" title="wealth"/><button type='roll' value='@{character_name} rolls a wealth check getting: [[@{wealth}]]' name='roll_Wealth'></button></span>
					<span class="table-data">&emsp;</span>
					<span class="table-data">Luck <input class="short-field" type="text" name="attr_luck" title="luck" value="10"/><button type='roll' value='@{character_name} makes a luck check with [[1d20<@{luck}]] successes' name='roll_Luck'></button></span>
					<span class="table-data">&emsp;</span>
					<span class="table-data">Profile <input type="number" name="attr_profile" title="personal-info-label" value="1" step=".1"/></span>
				</div>
			</div>
		</div>
		<div class="section-details">
			<div class="table">
				<div class="table-row">
					<span class="table-data">POWER: (<input class="number-text" type="text" name="attr_power_score" title="power_score"/>/<input class="number-text" type="text" name="attr_power_score_max" title="power_score_max" />)</span>
					<span class="table-data">&emsp;</span>
					<span class="table-data">MOVEMENT: Ground</span>
					<span class="table-data"><input  class="number-text" type="text" name="attr_movement_one" title="movement_one" value="round((@{strength_score}+@{endurance_score}+@{agility_score})/3)" disabled/></span>
					<span class="table-data">&emsp;</span>
					<span class="table-data"><input class="med-field" type="text" name="attr_movement_two" title="movement_two"/></span>
					<span class="table-data"><input class="med-field" type="text" name="attr_movement_three" title="movement_three"/></span>
				</div>
			</div>
		</div>
		<div class="section-details">
			<div class="table">
				<div class="table-row">
					<span class="table-data">HITS: (<input class="sheet-number-text" type="text" name="attr_hits_score" title="hits_score"/>/<input class="sheet-number-text" type="text" name="attr_hits_score_max" title="hits_score_max"/>)</span>
					<span class="table-data">&emsp;</span>
					<span class="table-data">HEALING: <input class="sheet-number-text" type="text" name="attr_healing_rate" title="healing_rate"/></span>
				</div>
			</div>
		</div>


		<div class="section-details">
			<div class="table">
				<div class="table-row">
					<span class="table-data">CAPS:</span>
					<span class="table-data">&nbsp;</span>
					<span class="table-data">BCs:</span>
					<span class="table-data"><input type="number" name="attr_bc_score" title="bc_score" value="floor((@{exp_total}/5)+10)" disabled/></span>
					<span class="table-data">&nbsp;</span>
					<span class="table-data">Abilty:</span>
					<span class="table-data">&nbsp;</span>
					<span class="table-data"><input type="number" name="attr_abilty_score" title="ability_score" value="floor(@{exp_total}/5)" disabled/></span>
					<span class="table-data">&nbsp;</span>
					<span class="table-data">Dmg:</span>
					<span class="table-data">&nbsp;</span>
					<span class="table-data"><input type="number" name="attr_dmg_score" title="dmg_score" value="floor((@{exp_total}/12.5)+3)" disabled/></span>
					<span class="table-data">&emsp;</span>
					<span class="table-data">GEAR:</span>
					<span class="table-data">&nbsp;</span>
					<span class="table-data">Break:</span>
					<span class="table-data"><input type="number" name="attr_break_score" title="break_score" value="round((@{exp_total}/25)+5)" disabled/></span>
					<span class="table-data">&nbsp;</span>
					<span class="table-data">Take:</span>
					<span class="table-data"><input type="number" name="attr_take_score" title="take_score" value="round((@{exp_total}/25)+6)" disabled/></span>
					<span class="table-data">&nbsp;</span>
					<span class="table-data">Disarm:</span>
					<span class="table-data"><input type="number" name="attr_disarm_score" title="disarm_score" value="round((@{exp_total}/25)+3)" disabled/></span>
					<span class="table-data">&nbsp;</span>
					<span class="table-data">BC:</span>
					<span class="table-data"><input type="number" name="attr_bcfinal_score" title="bcfinal_score" value="round((@{exp_total}/15)+6)" disabled/></span>
				</div>
			</div>
		</div>
	</div>
</div>
<div class="tab-content veh-tab">
	<div class="section-details">
		<div class="table">
			<div class="table-row">
				<span class="table-data">NAME: <input type="text" name="attr_vehicle_name" title="vehicle_name" /></span>
				<span class="table-data">&nbsp;</span>
				<span class="table-data">MODEL: <input type="text" name="attr_vehicle_model" title="vehicle_model" /></span>
				<span class="table-data">&nbsp;</span>
				<span class="table-data">OPERATOR: <input type="text" name="attr_vehicle_operator" title="vehicle_operator" /></span>
			</div>
		</div>
	</div>
	<div class="section-details">
		<div class="table">
			<div class="table-row">
				<span class="table-data">SYSTEM SPACES: <input class="sheet-number-text" type="text" name="attr_vehicle_spaces" title="vehicle_spaces" disabled /></span>
				<span class="table-data">&nbsp;</span>
				<span class="table-data">PROFILE: <input class="sheet-number-text" type="text" name="attr_vehicle_profile" title="vehicle_profile" disabled /></span>
				<span class="table-data">&nbsp;</span>
				<span class="table-data">WEIGHT: <input class="sheet-number-text" type="text" name="attr_vehicle_weight" title="vehicle_weight" disabled /> lbs</span>
				<span class="table-data">&nbsp;</span>
				<span class="table-data">MASS: <input class="sheet-number-text" type="text" name="attr_vehicle_mass" title="vehicle_mass" disabled /></span>
			</div>
		</div>
	</div>
	<div class="section-details">
		<div class="table">
			<div class="table-row">
				<span class="table-data">ARMOR:</span>
				<span class="table-data">&nbsp;</span>
				<span class="table-data">Kinetic: <input class="sheet-number-text" type="text" name="attr_vehicle_kinetic_armor" title="vehicle_kinetic_armor" disabled /></span>
				<span class="table-data">&nbsp;</span>
				<span class="table-data">Energy: <input class="sheet-number-text" type="text" name="attr_vehicle_energy_armor" title="vehicle_energy_armor" disabled /></span>
				<span class="table-data">&nbsp;</span>
				<span class="table-data">Biochem: <input class="sheet-number-text" type="text" name="attr_vehicle_bio_armor" title="vehicle_bio_armor" disabled /></span>
				<span class="table-data">&nbsp;</span>
				<span class="table-data">Entropy: <input class="sheet-number-text" type="text" name="attr_vehicle_entropy_armor" title="vehicle_entropy_armor" disabled /></span>
				<span class="table-data">&nbsp;</span>
				<span class="table-data">Psychic: <input class="sheet-number-text" type="text" name="attr_vehicle_psychic_armor" title="vehicle_psychic_armor" disabled /></span>
			</div>
		</div>
	</div>

	
</div>

<rolltemplate class="sheet-rolltemplate-powerdesc">
    <div class="container">
		<div class="header">Ability Description</div>
		<div class="row"><span>{{desc}}</span></div>
	</div>
</rolltemplate>


<script type="text/worker">

	/* ===== PARAMETERS ==========
	destination = the name of the attribute that stores the total quantity
	section = name of repeating fieldset, without the repeating_
	fields = the name of the attribute field to be summed
		  can be a single attribute: 'weight'
		  or an array of attributes: ['weight','number','equipped']
	multiplier (optional) = a multiplier to the entire fieldset total. For instance, if summing coins of weight 0.02, might want to multiply the final total by 0.02.
	*/
	const repeatingSum = (destination, section, fields, multiplier = 1) => {
		if (!Array.isArray(fields)) fields = [fields];
		getSectionIDs(`repeating_${section}`, idArray => {
			const attrArray = idArray.reduce( (m,id) => [...m, ...(fields.map(field => `repeating_${section}_${id}_${field}`))],[]);
			getAttrs(attrArray, v => {
				console.log("===== values of v: "+ JSON.stringify(v) +" =====");
					 // getValue: if not a number, returns 1 if it is 'on' (checkbox), otherwise returns 0..
				const getValue = (section, id,field) => parseFloat(v[`repeating_${section}_${id}_${field}`]) || (v[`repeating_${section}_${id}_${field}`] === 'on' ? 1 : 0); 
				const sumTotal = idArray.reduce((total, id) => total + fields.reduce((subtotal,field) => subtotal * getValue(section, id,field),1),0);
				setAttrs({[destination]: sumTotal * multiplier});    
			});
		});
	};

	on('change:repeating_powers remove:repeating_powers', function() {
		repeatingSum("abilityip_total","powers","ip_cost");
		repeatingSum("st_adj_total", "powers", "st_adj");
		repeatingSum("en_adj_total", "powers", "en_adj");
		repeatingSum("ag_adj_total", "powers", "ag_adj");
		repeatingSum("in_adj_total", "powers", "in_adj");
		repeatingSum("cl_adj_total", "powers", "cl_adj");
		updateFromBCs();
	});

	function updateFromBCs() {
		getAttrs([
			"strength_score",
			"endurance_score",
			"agility_score",
			"intelligence_score",
			"cool_score"
		], function(v) {
			let statTable = [
				{min: 0, max: 0, carry: 8, hth_init: 'd2-1', save: 6, hits_st: -3, hits_en: -5, hits_ag: -2, hits_cl: -1, heal: .2},
				{min: 1, max: 1, carry: 10, hth_init: 'd2-1', save: 7, hits_st: -3, hits_en: -5, hits_ag: -2, hits_cl: -1, heal: .3},
				{min: 2, max: 2, carry: 12, hth_init: 'd2-1', save: 7, hits_st: -3, hits_en: -5, hits_ag: -2, hits_cl: -1, heal: .3},
				{min: 3, max: 5, carry: 15, hth_init: 'd2', save: 8, hits_st: -2, hits_en: -3, hits_ag: -1, hits_cl: -0, heal: .5},
				{min: 6, max: 8, carry: 30, hth_init: 'd3', save: 9,  hits_st: 0, hits_en: -1, hits_ag: 0, hits_cl: 1, heal: .8},
				{min: 9, max: 11, carry: 60, hth_init: 'd4', save: 10, hits_st: 1, hits_en: 1, hits_ag: 1, hits_cl: 1, heal: 1},
				{min: 12, max: 14, carry: 120, hth_init: 'd6', save: 11, hits_st: 3, hits_en: 3, hits_ag: 2, hits_cl: 2, heal: 1.6},
				{min: 15, max: 17, carry: 240, hth_init: 'd6+1', save: 11, hits_st: 5, hits_en: 6, hits_ag: 3, hits_cl: 2, heal: 2.2},
				{min: 18, max: 20, carry: 480, hth_init: 'd8+1', save: 12, hits_st: 6, hits_en: 8, hits_ag: 5, hits_cl: 3, heal: 2.8},
				{min: 21, max: 23, carry: 960, hth_init: 'd10+1', save: 12, hits_st: 8, hits_en: 10, hits_ag: 6, hits_cl: 3, heal: 3.4},
				{min: 24, max: 26, carry: 1920, hth_init: '2d6', save: 13, hits_st: 10, hits_en: 13, hits_ag: 7, hits_cl: 5, heal: 3.9},
				{min: 27, max: 29, carry: 3840, hth_init: 'd6+d8', save: 13, hits_st: 12, hits_en: 15, hits_ag: 8, hits_cl: 5, heal: 4.5},
				{min: 30, max: 32, carry: 7680, hth_init: '2d8', save: 14, hits_st: 14, hits_en: 17, hits_ag: 9, hits_cl: 5, heal: 5.1},
				{min: 33, max: 35, carry: 15360, hth_init: 'd8+d10', save: 14, hits_st: 16, hits_en: 20, hits_ag: 10, hits_cl: 6, heal: 5.7},
				{min: 36, max: 38, carry: 30720, hth_init: '2d10', save: 15, hits_st: 17, hits_en: 22, hits_ag: 12, hits_cl: 6, heal: 6.3},
				{min: 39, max: 41, carry: 61440, hth_init: 'd10+d12', save: 15, hits_st: 19, hits_en: 25, hits_ag: 13, hits_cl: 7, heal: 6.9},
				{min: 42, max: 44, carry: 122880, hth_init: '2d12', save: 16, hits_st: 21, hits_en: 27, hits_ag: 14, hits_cl: 7, heal: 7.5},
				{min: 45, max: 47, carry: 245760, hth_init: '3d8', save: 16, hits_st: 23, hits_en: 29, hits_ag: 15, hits_cl: 8, heal: 8.1},
				{min: 48, max: 50, carry: 491520, hth_init: '2d8+d10', save: 17, hits_st: 25, hits_en: 32, hits_ag: 16, hits_cl: 9, heal: 8.7},
				{min: 51, max: 53, carry: 983040, hth_init: 'd8+2d10', save: 17, hits_st: 27, hits_en: 34, hits_ag: 17, hits_cl: 9, heal: 9.2},
				{min: 54, max: 56, carry: 1966080, hth_init: '3d10', save: 18, hits_st: 28, hits_en: 36, hits_ag: 19, hits_cl: 10, heal: 9.8},
				{min: 57, max: 59, carry: 3932160, hth_init: '2d10+d12', save: 18, hits_st: 30, hits_en: 39, hits_ag: 20, hits_cl: 10, heal: 10.4},
				{min: 60, max: 62, carry: 7864320, hth_init: 'd10+2d12', save: 19, hits_st: 32, hits_en: 41, hits_ag: 21, hits_cl: 11, heal: 11},
				{min: 63, max: 65, carry: 15728640, hth_init: '3d12', save: 19, hits_st: 34, hits_en: 43, hits_ag: 22, hits_cl: 12, heal: 11.6},
				{min: 66, max: 68, carry: 31457280, hth_init: '3d12+1', save: 20, hits_st: 36, hits_en: 46, hits_ag: 23, hits_cl: 12, heal: 12.2},
				{min: 69, max: 71, carry: 62914560, hth_init: '3d12+2', save: 20, hits_st: 38, hits_en: 48, hits_ag: 25, hits_cl: 13, heal: 12.8},
				{min: 72, max: 74, carry: 125829120, hth_init: '4d10', save: 21, hits_st: 39, hits_en: 50, hits_ag: 26, hits_cl: 13, heal: 13.4},
				{min: 75, max: 77, carry: 251658240, hth_init: '3d10+d12', save: 21, hits_st: 41, hits_en: 53, hits_ag: 27, hits_cl: 14, heal: 14},
				{min: 78, max: 80, carry: 503316480, hth_init: '2d10+2d12', save: 22, hits_st: 43, hits_en: 55, hits_ag: 28, hits_cl: 15, heal: 14.5},
				{min: 81, max: 83, carry: 1006632960, hth_init: 'd10+3d12', save: 22, hits_st: 45, hits_en: 58, hits_ag: 29, hits_cl: 15, heal: 15.1},
				{min: 84, max: 86, carry: 2013265920, hth_init: '4d12', save: 23, hits_st: 47, hits_en: 60, hits_ag: 30, hits_cl: 16, heal: 15.7},
				{min: 87, max: 89, carry: 4026531840, hth_init: '4d12+1', save: 23, hits_st: 48, hits_en: 62, hits_ag: 32, hits_cl: 16, heal: 16.3},
				{min: 90, max: 92, carry: 8053063680, hth_init: '5d10', save: 24, hits_st: 50, hits_en: 65, hits_ag: 33, hits_cl: 17, heal: 16.9},
				{min: 93, max: 95, carry: 16106127360, hth_init: '4d10+d12', save: 24, hits_st: 52, hits_en: 67, hits_ag: 34, hits_cl: 17, heal: 17.5},
				{min: 96, max: 98, carry: 32212254720, hth_init: '3d10+2d12', save: 25, hits_st: 54, hits_en: 69, hits_ag: 35, hits_cl: 18, heal: 18.1}
			];
	
			let stResult = statTable.filter(tableRow => (tableRow.min <= v.strength_score && tableRow.max >= v.strength_score));
			let enResult = statTable.filter(tableRow => (tableRow.min <= v.endurance_score && tableRow.max >= v.endurance_score));
			let agResult = statTable.filter(tableRow => (tableRow.min <= v.agility_score && tableRow.max >= v.agility_score));
			let inResult = statTable.filter(tableRow => (tableRow.min <= v.intelligence_score && tableRow.max >= v.intelligence_score));
			let clResult = statTable.filter(tableRow => (tableRow.min <= v.cool_score && tableRow.max >= v.cool_score));

			console.log('EN score ' + v.endurance_score + ' save ' + enResult[0].save);

			setAttrs({
				hid_carry: stResult[0].carry,
				hid_en_save: enResult[0].save,
				hid_ag_save: agResult[0].save,
				hid_in_save: inResult[0].save,
				hid_cl_save: clResult[0].save
			});
		});
	};


	const buttonlist = ["character","vehicle"];
    buttonlist.forEach(button => {
        on(`clicked:${button}`, function() {
            setAttrs({
                sheetTab: button
            });
        });
    });
    


</script>
